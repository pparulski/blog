---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

import { getCollection, type CollectionEntry } from 'astro:content';

type Props = CollectionEntry<'blog'>['data'];

const { title, description, pubDate, updatedDate, heroImage, lang, translationKey } = Astro.props as Props;

const otherLang = lang === 'en' ? 'pl' : 'en';

let translationUrl: string | null = null;
if (translationKey) {
	const siblings = await getCollection('blog', ({ data }) =>
		data.translationKey === translationKey && data.lang === otherLang,
	);
	const sibling = siblings[0];
	if (sibling) {
		const siblingSlug = sibling.slug.replace(`${otherLang}/`, '');
		translationUrl = `/${otherLang}/blog/${siblingSlug}/`;
	}
}

---

<html lang={lang}>
		{translationUrl && (
			<script is:inline>
				(() => {
					try {
						const currentLang = "${lang}";
						const otherUrl = "${translationUrl}";
						const langs = (navigator.languages && navigator.languages.length
							? navigator.languages
							: [navigator.language]
						).map((l) => (l || '').toLowerCase());
						const prefersPl = langs.some((l) => l === 'pl' || l.startsWith('pl-'));
						const preferredLang = prefersPl ? 'pl' : 'en';

						if (preferredLang !== currentLang) {
							// Avoid redirect loops if already at target.
							if (!location.pathname.startsWith(`/${preferredLang}/`)) {
								location.replace(otherUrl);
							}
						}
					} catch {}
				})();
			</script>
		)}
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				width: calc(100% - 2rem);
				max-width: 100%;
				margin: 0;
				padding: 0;
			}
			.hero-image {
				width: 720px;
				max-width: calc(100% - 2rem);
				margin: 1.5rem auto 0;
			}
			.hero-image img {
				display: block;
				width: 100%;
				border-radius: 2px;
				filter: grayscale(100%);
			}
			.prose {
				width: 720px;
				max-width: calc(100% - 2rem);
				margin: 0 auto;
				padding: 1.75rem 1rem 2.5rem;
				color: rgb(var(--gray-dark));
			}
			.title {
				margin-bottom: 1.25rem;
				padding: 1.25rem 0 0;
				text-align: left;
				line-height: 1.1;
			}
			.title h1 {
				margin: 0.35rem 0 0.75rem;
				font-weight: 400;
			}
			.date {
				margin-bottom: 0.5rem;
				color: rgb(var(--gray));
				font-size: 0.95rem;
			}
			.date-row {
				display: flex;
				align-items: baseline;
				justify-content: space-between;
				gap: 1rem;
				flex-wrap: wrap;
			}
			.lang-toggle {
				display: inline-flex;
				gap: 0.5rem;
				align-items: baseline;
				margin-top: 0;
				font-size: 0.85rem;
				letter-spacing: 0.04em;
				text-transform: uppercase;
				color: rgb(var(--gray));
			}
			.lang-toggle a {
				text-decoration: none;
				border-bottom: 1px solid rgba(0, 0, 0, 0.25);
			}
			.lang-toggle a:hover {
				border-bottom-color: rgba(0, 0, 0, 0.5);
			}
			.lang-toggle .active {
				color: rgb(var(--gray-dark));
				border-bottom: 1px solid rgba(0, 0, 0, 0.65);
			}
			.lang-toggle .disabled {
				opacity: 0.45;
				border-bottom: 1px solid transparent;
				cursor: not-allowed;
			}
			.last-updated-on {
				font-style: italic;
				opacity: 0.8;
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{heroImage && (
						<img src={heroImage} alt="" loading="eager" decoding="async" />
					)}
				</div>
				<div class="prose">
					<div class="title">
						<div class="date">
							<div class="date-row">
								<FormattedDate date={pubDate} lang={lang} format="locale" />
								<div class="lang-toggle" aria-label="Language">
								{lang === 'en' ? (
									<span class="active">EN</span>
								) : translationUrl ? (
									<a href={translationUrl}>EN</a>
								) : (
									<span class="disabled" aria-disabled="true" title="No English version yet">EN</span>
								)}
								<span aria-hidden="true">Â·</span>
								{lang === 'pl' ? (
									<span class="active">PL</span>
								) : translationUrl ? (
									<a href={translationUrl}>PL</a>
								) : (
									<span class="disabled" aria-disabled="true" title="Brak polskiej wersji">PL</span>
								)}
								</div>
							</div>
							{
								updatedDate && (
									<div class="last-updated-on">
										Last updated on <FormattedDate date={updatedDate} lang={lang} format="locale" />
									</div>
								)
							}
						</div>
						<h1>{title}</h1>
						<hr />
					</div>
					<slot />
				</div>
			</article>
		</main>
		<Footer />
	</body>
</html>
